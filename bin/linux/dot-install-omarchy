#!/bin/bash

# Install omarchy desktop environment

set -euo pipefail

REPOS_DIR="$HOME/Repos"
OMARCHY_REPO="$REPOS_DIR/omarchy"
OMARCHY_INSTALL="$HOME/.local/share/omarchy"
OMARCHY_UPSTREAM="https://github.com/basecamp/omarchy.git"

echo "Bootstrapping omarchys toolchain..."
echo ""

# Create Repos directory if needed
mkdir -p "$REPOS_DIR"

# Clone omarchy if not present
if [[ ! -d "$OMARCHY_REPO" ]]; then
  echo "Cloning omarchy from $OMARCHY_UPSTREAM..."
  git clone "$OMARCHY_UPSTREAM" "$OMARCHY_REPO"
  echo "✓ Omarchy cloned"
else
  echo "✓ Omarchy repo found at $OMARCHY_REPO"
fi

echo ""

# Symlink omarchy to local share (installation location)
if [[ ! -e "$OMARCHY_INSTALL" ]]; then
  echo "Symlinking omarchy to $OMARCHY_INSTALL..."
  ln -s "$OMARCHY_REPO" "$OMARCHY_INSTALL"
  echo "✓ Omarchy symlinked to $OMARCHY_INSTALL"
else
  echo "✓ Omarchy already installed at $OMARCHY_INSTALL"
fi

echo ""

# Create omarchy config directories
mkdir -p ~/.config/omarchy/current
echo "✓ Created ~/.config/omarchy/current/"

mkdir -p ~/.config/omarchy/themed
echo "✓ Created ~/.config/omarchy/themed/"

# Create config directories for omarchy refresh commands
echo "Creating config directories for refresh commands..."
for dir in autostart elephant fastfetch hypr swayosd systemd tmux walker waybar mako; do
  mkdir -p ~/.config/"$dir"
done
echo "✓ Created config directories"

# Setup fontconfig
echo ""
echo "Setting up fontconfig..."
mkdir -p ~/.config/fontconfig
cp "$OMARCHY_INSTALL/config/fontconfig/fonts.conf" ~/.config/fontconfig/
echo "✓ Fontconfig configured"

# Setup theme system (Nautilus icons, mako, browser policies, etc.)
echo ""
echo "Setting up theme system..."
source "$OMARCHY_INSTALL/install/config/theme.sh"

# Symlink custom templates
for template in "$DOTFILES"/templates/*.tpl; do
  [[ -f $template ]] || continue
  filename=$(basename "$template")
  "$DOTFILES/bin/common/dot-cmd-symlink" "$template" ~/.config/omarchy/themed/"$filename"
done

# Setup Walker and Elephant
echo ""
echo "Setting up Walker and Elephant..."
source "$OMARCHY_INSTALL/install/config/walker-elephant.sh"
source "$OMARCHY_INSTALL/install/first-run/elephant.sh"
"$OMARCHY_INSTALL/bin/omarchy-refresh-walker"
echo "✓ Walker and Elephant configured"

# Override default theme with kanagawa
echo ""
echo "Setting kanagawa theme..."
OMARCHY_PATH="$OMARCHY_INSTALL" "$OMARCHY_INSTALL/bin/omarchy-theme-set" kanagawa

echo ""
echo "✓ Omarchy bootstrap complete!"
echo ""
echo "Next steps:"
echo "  1. Ensure OMARCHY_PATH is set in your shell config:"
echo "     export OMARCHY_PATH=\"\$HOME/.local/share/omarchy\""
echo "  2. Add omarchy bin to PATH:"
echo "     export PATH=\"\$OMARCHY_PATH/bin:\$PATH\""
echo "  3. Source your shell config (or restart terminal)"
echo ""
echo "Available commands:"
echo "  omarchy-theme-set <theme>    - Switch themes"
echo "  omarchy-theme-list            - List available themes"
echo "  omarchy-theme-current         - Show current theme"
