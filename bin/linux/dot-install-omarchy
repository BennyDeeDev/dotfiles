#!/bin/bash

# Install omarchy desktop environment

set -euo pipefail

REPOS_DIR="$HOME/Repos"
DOTFILES="$REPOS_DIR/dotfiles"
OMARCHY_REPO="$REPOS_DIR/omarchy"
OMARCHY_INSTALL="$HOME/.local/share/omarchy"
OMARCHY_UPSTREAM="https://github.com/basecamp/omarchy.git"

echo "Bootstrapping omarchys toolchain..."
echo ""

# Create Repos directory if needed
mkdir -p "$REPOS_DIR"

# Clone omarchy if not present
if [[ ! -d "$OMARCHY_REPO" ]]; then
  echo "Cloning omarchy from $OMARCHY_UPSTREAM..."
  git clone "$OMARCHY_UPSTREAM" "$OMARCHY_REPO"
  echo "✓ Omarchy cloned"
else
  echo "✓ Omarchy repo found at $OMARCHY_REPO"
fi

echo ""

# Symlink omarchy to local share (installation location)
if [[ ! -e "$OMARCHY_INSTALL" ]]; then
  echo "Symlinking omarchy to $OMARCHY_INSTALL..."
  ln -s "$OMARCHY_REPO" "$OMARCHY_INSTALL"
  echo "✓ Omarchy symlinked to $OMARCHY_INSTALL"
else
  echo "✓ Omarchy already installed at $OMARCHY_INSTALL"
fi

echo ""

# Create omarchy config directories
mkdir -p ~/.config/omarchy/current
echo "✓ Created ~/.config/omarchy/current/"

mkdir -p ~/.config/omarchy/themed
echo "✓ Created ~/.config/omarchy/themed/"

# Setup default keyring
echo ""
echo "Setting up default keyring..."
"$OMARCHY_INSTALL/install/login/default-keyring.sh" > /dev/null
echo "✓ Default keyring configured"

# Setup fontconfig
echo ""
echo "Setting up fontconfig..."
mkdir -p ~/.config/fontconfig
cp "$OMARCHY_INSTALL/config/fontconfig/fonts.conf" ~/.config/fontconfig/
echo "✓ Fontconfig configured"

# Symlink infrastructure configs from omarchy
echo ""
echo "Symlinking infrastructure configs from omarchy..."
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/alacritty" ~/.config/alacritty
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/brave-flags.conf" ~/.config/brave-flags.conf
"$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/btop" ~/.config/btop
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/chromium" ~/.config/chromium
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/chromium-flags.conf" ~/.config/chromium-flags.conf
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/elephant" ~/.config/elephant  # Managed by walker-elephant.sh
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/environment.d" ~/.config/environment.d
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/fastfetch" ~/.config/fastfetch
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/fcitx5" ~/.config/fcitx5
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/ghostty" ~/.config/ghostty  # Managed in dotfiles
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/git" ~/.config/git  # Managed in dotfiles
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/hypr" ~/.config/hypr  # Managed in dotfiles
"$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/hyprland-preview-share-picker" ~/.config/hyprland-preview-share-picker
"$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/imv" ~/.config/imv
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/kitty" ~/.config/kitty
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/lazygit" ~/.config/lazygit
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/omarchy" ~/.config/omarchy  # Omarchy metadata (managed by theme system)
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/opencode" ~/.config/opencode
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/starship.toml" ~/.config/starship.toml
"$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/swayosd" ~/.config/swayosd
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/systemd/user" ~/.config/systemd/user
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/tmux" ~/.config/tmux
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/Typora" ~/.config/Typora
"$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/uwsm" ~/.config/uwsm  # Managed in dotfiles
"$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/walker" ~/.config/walker
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/waybar" ~/.config/waybar  # Managed in dotfiles
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/wiremix" ~/.config/wiremix
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/xdg-terminals.list" ~/.config/xdg-terminals.list  # Managed in dotfiles
# "$DOTFILES/bin/common/dot-cmd-symlink" "$OMARCHY_INSTALL/config/xournalpp" ~/.config/xournalpp
echo "✓ Infrastructure configs symlinked"

# Setup theme system (Nautilus icons, mako, browser policies, etc.)
echo ""
echo "Setting up theme system..."
source "$OMARCHY_INSTALL/install/config/theme.sh"

# Symlink custom templates
for template in "$DOTFILES"/templates/*.tpl; do
  [[ -f $template ]] || continue
  filename=$(basename "$template")
  "$DOTFILES/bin/common/dot-cmd-symlink" "$template" ~/.config/omarchy/themed/"$filename"
done

# Setup Walker and Elephant
echo ""
echo "Setting up Walker and Elephant..."
source "$OMARCHY_INSTALL/install/config/walker-elephant.sh"
source "$OMARCHY_INSTALL/install/first-run/elephant.sh"
echo "✓ Walker and Elephant configured"

# Override default theme with kanagawa
echo ""
echo "Setting kanagawa theme..."
OMARCHY_PATH="$OMARCHY_INSTALL" "$OMARCHY_INSTALL/bin/omarchy-theme-set" kanagawa

echo ""
echo "✓ Omarchy bootstrap complete!"
echo ""
echo "Next steps:"
echo "  1. Ensure OMARCHY_PATH is set in your shell config:"
echo "     export OMARCHY_PATH=\"\$HOME/.local/share/omarchy\""
echo "  2. Add omarchy bin to PATH:"
echo "     export PATH=\"\$OMARCHY_PATH/bin:\$PATH\""
echo "  3. Source your shell config (or restart terminal)"
echo ""
echo "Available commands:"
echo "  omarchy-theme-set <theme>    - Switch themes"
echo "  omarchy-theme-list            - List available themes"
echo "  omarchy-theme-current         - Show current theme"
