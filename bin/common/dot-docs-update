#!/bin/bash

# Clone or update docs repos from Docsfile

set -euo pipefail

DOCS_DIR="$HOME/Docs"
DOCSFILE="$HOME/Repos/dotfiles/Docsfile"

mkdir -p "$DOCS_DIR"

while IFS= read -r line || [[ -n "$line" ]]; do
  [[ "$line" =~ ^#.*$ ]] && continue
  [[ -z "$line" ]] && continue

  repo=$(echo "$line" | awk '{print $1}')
  name=$(echo "$line" | awk '{print $2}')
  subdir=$(echo "$line" | awk '{print $3}')
  [[ -z "$name" ]] && name="${repo##*/}" && name="${name%.git}"
  target_dir="$DOCS_DIR/$name"

  if [[ -d "$target_dir" ]]; then
    echo "Updating $name..."
    git -C "$target_dir" pull
  elif [[ -n "$subdir" ]]; then
    echo "Cloning $name (sparse: $subdir)..."
    git clone --no-checkout --depth=1 --filter=blob:none "$repo" "$target_dir"
    git -C "$target_dir" sparse-checkout set "$subdir"
    git -C "$target_dir" checkout
  else
    echo "Cloning $name..."
    git clone --depth 1 "$repo" "$target_dir"
  fi
done < "$DOCSFILE"

echo "Done! Docs available in $DOCS_DIR"
